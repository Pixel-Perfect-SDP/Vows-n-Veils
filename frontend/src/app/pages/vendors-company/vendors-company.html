<header class="topbar">
  <section class="logo-area">
    <img class="logo-img" src="assets/logo.jpg" alt="Vows & Veils logo" />
    <h1 class="logo-text">Vows & Veils</h1>
  </section>

  <nav class="nav-links">
    <a (click)="refreshServices()"  *ngIf="hasVendorCompany">Refresh</a>
    <a (click)="toggleServiceForm()"  *ngIf="hasVendorCompany">
        {{ showServiceForm ? 'Cancel' : 'Add service' }}
    </a>
    <a (click)="logout()">Log out</a>
    
  </nav>
</header>

<section class="vendorsCompany-section">

  <section class="loading-container" *ngIf="hasVendorCompany === null">
    <section class="Loading-1"></section>
    <section class="Loading-2"></section>
  </section>

  <section class="has-vendor-company" *ngIf="hasVendorCompany && companyVendorData">

    <section class="vendor-company-details">
      <p class="company-name">Welcome, {{ companyVendorData.companyName }}</p>
    </section>
  </section>

  <section class="services" *ngIf="hasVendorCompany && companyVendorData">
    <h3 class="myServices">My services:</h3>

    <section class="vendor-company-form" *ngIf="showServiceForm">
      <form [formGroup]="serviceForm" (ngSubmit)="addService()">
        <label>Service name *</label>
        <input formControlName="serviceName" />

        <label>Type *</label>
        <select formControlName="type">
          <option value="" disabled>Select…</option>
          <option *ngFor="let t of serviceTypes" [value]="t">{{ t }}</option>
        </select>

        <label>Phone number *</label>
        <input type="tel" formControlName="phonenumber" />

        <label>Price (R) *</label>
        <input type="number" formControlName="price" min="0" step="0.01" />

        <label>Capacity</label>
        <input type="number" formControlName="capacity" min="0" step="1" />

        <label>Description</label>
        <textarea rows="3" formControlName="description"></textarea>

        <label>Booking notes (optional)</label>
        <textarea rows="2" formControlName="bookingNotes"></textarea>

        <section style="display:flex; gap:10px; margin-top:10px">
          <button type="submit" [disabled]="serviceForm.invalid || busy">
            {{ busy ? 'Saving…' : 'Save service' }}
          </button>
          <button type="button" (click)="serviceForm.reset(defaultServiceValues)" [disabled]="busy">Clear</button>
        </section>

        <p *ngIf="errorMsg" style="color:#b45353;margin-top:8px">{{ errorMsg }}</p>
        <p *ngIf="successMsg" style="color:#166534;margin-top:8px">{{ successMsg }}</p>
      </form>
    </section>

    <section *ngIf="loadingServices" style="color:#6b7280">Loading services…</section>
    <section class="empty-services" *ngIf="!loadingServices && services.length === 0" >
      No services yet — add your first one.
    </section>

    <section *ngIf="services.length > 0" class="services-table-wrapper">
      <table class="services-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Phone</th>
            <th>Price</th>
            <th>Capacity</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of services; trackBy: trackById">
            <td>{{ s.serviceName }}</td>
            <td>{{ s.type }}</td>

            <td >
              <ng-container *ngIf="editPhoneId !== s.id; else editingPhone">
                <span>{{ s.phonenumber || '—' }}</span>
                <button (click)="beginEditPhone(s)" [disabled]="phoneBusyId===s.id">
                  {{ s.phonenumber ? 'Edit' : 'Add' }}
                </button>
              </ng-container>
              <ng-template #editingPhone>
                <section>
                <input type="tel" [value]="phoneInput" (input)="phoneInput=$any($event.target).value" />
                  <button (click)="saveEditPhone(s)" [disabled]="phoneBusyId===s.id">
                    {{ phoneBusyId===s.id ? 'Saving…' : 'Save' }}
                  </button>
                  <button (click)="cancelEditPhone()" [disabled]="phoneBusyId===s.id">Cancel</button>
                </section>
                <section *ngIf="phoneErrorId===s.id">{{ phoneInlineError }}</section>
              </ng-template>
            </td>

            <td >
              <ng-container *ngIf="editPriceId !== s.id; else editingPrice">
                <span>R{{ s.price | number:'1.0-2' }}</span>
                <button  (click)="beginEditPrice(s)" [disabled]="priceBusyId===s.id">Edit</button>
              </ng-container>
              <ng-template #editingPrice>
                <section >
                  <input type="number" min="0" step="0.01" [value]="priceInput" (input)="priceInput=+$any($event.target).value"  />
                  <button (click)="saveEditPrice(s)" [disabled]="priceBusyId===s.id">
                    {{ priceBusyId===s.id ? 'Saving…' : 'Save' }}
                  </button>
                  <button (click)="cancelEditPrice()" [disabled]="priceBusyId===s.id">Cancel</button>
                </section>
                <section *ngIf="priceErrorId===s.id">{{ priceInlineError }}</section>
              </ng-template>
            </td>

            <td >
              <ng-container *ngIf="editCapacityId !== s.id; else editingCapacity">
                <span>{{ s.capacity ?? '—' }}</span>
                <button  (click)="beginEditCapacity(s)" [disabled]="capacityBusyId===s.id">
                  {{ s.capacity == null ? 'Add' : 'Edit' }}
                </button>
              </ng-container>
              <ng-template #editingCapacity>
                <section >
                  <input type="number" min="0" step="1" [value]="capacityInput" (input)="capacityInput=+$any($event.target).value"/>
                  <button (click)="saveEditCapacity(s)" [disabled]="capacityBusyId===s.id">
                    {{ capacityBusyId===s.id ? 'Saving…' : 'Save' }}
                  </button>
                  <button (click)="cancelEditCapacity()" [disabled]="capacityBusyId===s.id">Cancel</button>
                </section>
                <section *ngIf="capacityErrorId===s.id">{{ capacityInlineError }}</section>
              </ng-template>
            </td>

            <td >
              <span class="status-pill {{ s.status || 'pending' }}">
                {{ s.status || 'pending' }}
              </span>
            </td>
            <td >
              <button (click)="deleteService(s)" [disabled]="busyId===s.id">
                {{ busyId===s.id ? 'Deleting…' : 'Delete' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <h3 class="incomingOrders">Incoming orders</h3>

    <section *ngIf="loadingOrders">Loading orders…</section>
    <section class="noOrdersYet" *ngIf="!loadingOrders && orders.length === 0" >
      No orders yet.
    </section>

    <section class="orders-table-wrapper" *ngIf="orders.length > 0">
      <table class="orders-table">
        <thead>
          <tr >
            <th >Placed</th>
            <th >Service</th>
            <th >Guests</th>
            <th >Date</th>
            <th >Time</th>
            <th >Notes</th>
            <th >Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of orders; trackBy: trackById" >
            <td >{{ o.createdAtDate || o.startAtDate | date:'MMM d, y, h:mm a' }}</td>
            <td >{{ getServiceName(o.vendorID) }}</td>
            <td >{{ o.guestsNum }}</td>
            <td>{{ o.startAtDate | date:'MMM d, y' }}</td>
            <td >{{ o.startAtDate | date:'shortTime' }} – {{ o.endAtDate | date:'shortTime' }}</td>
            <td >
              <span >{{ o.note || '—' }}</span>
            </td>
            <td >
              <span class="ordersStatus {{ o.status | lowercase }}">
                {{ o.status }}
              </span>
            </td>
            <td >
              <button (click)="acceptOrder(o)" [disabled]="!canAct(o) || orderBusyId===o.id">
                {{ orderBusyId===o.id && orderBusyAction==='accept' ? 'Accepting…' : 'Accept' }}
              </button>
              <button (click)="declineOrder(o)" [disabled]="!canAct(o) || orderBusyId===o.id">
                {{ orderBusyId===o.id && orderBusyAction==='decline' ? 'Declining…' : 'Decline' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <p *ngIf="errorMsg" >{{ errorMsg }}</p>
  </section>



  <section class="create-vendor-company" *ngIf="hasVendorCompany === false">
    <section class="vendor-company-card">
      <img src="assets/logo.jpg" alt="Vows & Veils logo" class="logo" />
      <h2>Join as a vendor company</h2>
      <p>Fill in the details to get started!</p>
    </section>

    <section class="vendor-company-form">
      <form [formGroup]="form" (ngSubmit)="createVendorCompany()">
        <label>Company Name:</label>
        <input formControlName="companyName" />

        <label>Contact Email:</label>
        <input type="email" formControlName="companyEmail" />

        <label>Phone Number:</label>
        <input formControlName="companyNumber" />

        <button type="submit" [disabled]="form.invalid">Create vendor account</button>
      </form>
    </section>
  </section>

</section>
